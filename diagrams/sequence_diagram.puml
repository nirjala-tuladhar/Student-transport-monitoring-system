@startuml Student_Transport_Sequence_Diagram
skinparam linetype ortho
skinparam backgroundColor #FEFEFE
skinparam sequenceParticipantBackgroundColor #E6FFE6
skinparam sequenceParticipantBorderColor #228B22
skinparam shadowing false

title Parent Tracking Bus Location - Sequence Diagram

actor Parent
participant "Parent App" as App
participant "ParentService" as Service
participant "Supabase\nDatabase" as DB
participant "Realtime\nChannel" as Realtime
participant "MapTab" as Map

Parent -> App : Opens Parent Panel
activate App

App -> Service : getMyChildWithBus()
activate Service

Service -> DB : SELECT student with bus info
activate DB
DB --> Service : Student data + bus_id
deactivate DB

Service --> App : Student & Bus data
deactivate Service

App -> Map : Initialize MapTab
activate Map

Map -> Service : getMyChildWithBus()
activate Service

Service -> DB : SELECT student, school, bus_stop
activate DB
DB --> Service : Coordinates data
deactivate DB

Service --> Map : Home & School coordinates
deactivate Service

Map -> Map : Set home marker\nSet school marker

Map -> Realtime : Subscribe to\nbus_locations channel
activate Realtime

Realtime --> Map : Subscription confirmed
deactivate Realtime

Parent -> App : Views Map Tab
App --> Parent : Shows map with markers

== Real-time Location Updates ==

Realtime -> Map : New bus location event
activate Map

Map -> Map : Update bus marker\nCalculate ETA

alt Bus near pickup point
  Map -> Service : Check if notification sent
  activate Service
  
  Service -> DB : Check notification log
  activate DB
  DB --> Service : Not sent yet
  deactivate DB
  
  Service -> DB : INSERT notification
  activate DB
  DB --> Service : Success
  deactivate DB
  
  Service --> Map : Notification sent
  deactivate Service
  
  Map --> Parent : Show "Bus Approaching" alert
end

Map --> Parent : Updated bus position
deactivate Map

== Parent Edits Bus Stop Location ==

Parent -> App : Clicks Edit Location button
App -> App : Navigate to\nEditBusStopScreen

Parent -> App : Enters new coordinates\n(27.7172, 85.3240)

App -> Service : persistHomeCoords(studentId, lat, lng)
activate Service

Service -> DB : UPDATE students\nSET bus_stop_lat, bus_stop_lng
activate DB
DB --> Service : Update successful
deactivate DB

Service --> App : Success
deactivate Service

App -> App : Navigate back\nReload data

App -> Service : getMyChildWithBus()
activate Service

Service -> DB : SELECT updated student data
activate DB
DB --> Service : New coordinates
deactivate DB

Service --> App : Updated data
deactivate Service

App -> Map : Rebuild MapTab\nwith new coordinates
activate Map

Map -> Map : Set home marker\nat new location\nCenter map

Map --> Parent : Shows updated home marker
deactivate Map

Parent -> App : Closes app
deactivate App

@enduml
